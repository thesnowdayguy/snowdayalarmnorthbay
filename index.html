<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>North Bay Snow Day Alarm</title>
    <style>
        body { 
            font-family: Arial; 
            text-align: center; 
            padding: 20px; 
            max-width: 500px; 
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: background 0.5s;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin: 20px;
        }
        h1 { font-size: 28px; margin-bottom: 20px; }
        .time-input {
            font-size: 24px;
            padding: 10px;
            border-radius: 10px;
            border: none;
            margin: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        button {
            font-size: 18px;
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 25px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover { transform: scale(1.05); }
        button.cancel { background: #f44336; }
        .alarm-active {
            background: #ff4444 !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .ringing-mode {
            background: linear-gradient(45deg, #ff0000, #ff6600) !important;
            animation: emergency 0.5s infinite;
        }
        @keyframes emergency {
            0%, 100% { background: linear-gradient(45deg, #ff0000, #ff6600); }
            50% { background: linear-gradient(45deg, #ff6600, #ffff00); }
        }
        .status { margin-top: 20px; padding: 15px; border-radius: 10px; }
        .hidden { display: none; }
        .alarm-controls {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        #stopAlarm {
            background: #ff0000;
            font-size: 24px;
            padding: 20px 40px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå®Ô∏è North Bay Snow Day Alarm</h1>
        
        <div>
            <label for="alarmTime">Set Alarm Time:</label><br>
            <input type="time" id="alarmTime" class="time-input" value="07:00">
        </div>
        
        <button id="setButton" onclick="toggleAlarm()">Set Alarm</button>
        
        <div id="status" class="status">
            Ready to set alarm
        </div>
        
        <div id="alarmControls" class="alarm-controls hidden">
            <h2>üö® ALARM RINGING! üö®</h2>
            <button id="stopAlarm" onclick="stopAlarm()">STOP ALARM</button>
            <p id="alarmReason">Wake up!</p>
        </div>
        
        <button class="manual-check" onclick="manualCheck()" style="background: #2196F3; margin-top: 20px;">
            Check Snow Day Status Now
        </button>
        
        <div id="lastCheck" style="font-size: 12px; opacity: 0.8; margin-top: 10px;"></div>
    </div>

    <script>
        let alarmSet = false;
        let alarmTime = '07:00';
        let alarmTimeout = null;
        let snowDayCheckInterval = null;
        let isSnowDay = false;
        
        // Audio context for alarm sound
        let audioContext = null;
        let oscillator = null;
        let gainNode = null;

        // Initialize audio
        function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        function toggleAlarm() {
            if (!audioContext) initAudio();
            
            alarmSet = !alarmSet;
            const button = document.getElementById('setButton');
            const timeInput = document.getElementById('alarmTime');
            
            if (alarmSet) {
                alarmTime = timeInput.value;
                button.textContent = 'Cancel Alarm';
                button.className = 'cancel alarm-active';
                timeInput.disabled = true;
                scheduleAlarm();
                updateStatus('Alarm set for ' + alarmTime + ' - will check for snow day first');
            } else {
                button.textContent = 'Set Alarm';
                button.className = '';
                timeInput.disabled = false;
                clearTimeout(alarmTimeout);
                clearInterval(snowDayCheckInterval);
                updateStatus('Alarm cancelled');
                document.body.className = '';
            }
        }

        function scheduleAlarm() {
            // Schedule snow day checks every 5 minutes
            checkSnowDay(); // Check immediately
            snowDayCheckInterval = setInterval(checkSnowDay, 300000); // Every 5 minutes
            
            // Calculate time until alarm
            const now = new Date();
            const [hours, minutes] = alarmTime.split(':');
            const alarmDateTime = new Date();
            alarmDateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            if (alarmDateTime < now) {
                alarmDateTime.setDate(alarmDateTime.getDate() + 1); // Tomorrow
            }
            
            const timeUntilAlarm = alarmDateTime - now;
            
            // Schedule alarm
            alarmTimeout = setTimeout(() => {
                triggerAlarm();
            }, timeUntilAlarm);
            
            console.log(`Alarm scheduled for ${alarmDateTime} (${Math.round(timeUntilAlarm/60000)} minutes)`);
        }

        function triggerAlarm() {
            // Check snow day status first
            if (isSnowDay) {
                updateStatus('‚ùÑÔ∏è SNOW DAY! Alarm cancelled - go back to sleep!', 'snowday');
                playSound('cancelled');
                document.body.className = 'ringing-mode';
                setTimeout(() => {
                    document.body.className = '';
                }, 3000);
            } else {
                // Normal day - ring the alarm!
                updateStatus('üö® ALARM RINGING! Wake up!', 'normal');
                document.getElementById('alarmReason').textContent = 'Time to wake up! Buses are running.';
                document.getElementById('alarmControls').classList.remove('hidden');
                document.body.className = 'ringing-mode';
                playSound('alarm');
                
                // Keep ringing until stopped
                keepRinging = true;
                continuousAlarm();
            }
        }

        let keepRinging = false;
        function continuousAlarm() {
            if (keepRinging) {
                playSound('alarm');
                setTimeout(continuousAlarm, 2000); // Ring every 2 seconds
            }
        }

        function stopAlarm() {
            keepRinging = false;
            if (oscillator) {
                oscillator.stop();
                oscillator = null;
            }
            document.getElementById('alarmControls').classList.add('hidden');
            document.body.className = '';
            updateStatus('Alarm stopped - good morning! üåÖ');
            
            // Reset for tomorrow
            setTimeout(() => {
                if (alarmSet) {
                    scheduleAlarm();
                }
            }, 5000);
        }

        function playSound(type) {
            if (!audioContext) return;
            
            // Stop previous sound
            if (oscillator) {
                oscillator.stop();
            }
            
            oscillator = audioContext.createOscillator();
            gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'alarm') {
                oscillator.frequency.value = 800; // Annoying high pitch
                gainNode.gain.value = 0.3;
                oscillator.type = 'square'; // Harsh sound
            } else if (type === 'cancelled') {
                oscillator.frequency.value = 400; // Gentle low tone
                gainNode.gain.value = 0.2;
                oscillator.type = 'sine';
            }
            
            oscillator.start();
            
            if (type === 'cancelled') {
                // Fade out for cancelled
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);
                oscillator.stop(audioContext.currentTime + 2);
            }
        }

        async function checkSnowDay() {
            try {
                updateStatus('Checking snow day status...');
                
                // Use CORS proxy
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const targetUrl = 'https://npssts.ca/index.php/delays-cancellations';
                
                const response = await fetch(proxyUrl + targetUrl);
                const html = await response.text();
                
                isSnowDay = isValidSnowDay(html);
                const now = new Date().toLocaleTimeString();
                
                if (isSnowDay) {
                    updateStatus('‚ùÑÔ∏è SNOW DAY DETECTED! Alarm will be cancelled', 'snowday');
                    document.title = '‚ùÑÔ∏è Snow Day!';
                } else {
                    updateStatus('üöå Buses running normally - alarm will ring', 'normal');
                    document.title = 'Snow Day Alarm';
                }
                
                document.getElementById('lastCheck').textContent = `Last check: ${now}`;
                
            } catch (error) {
                updateStatus('‚ùå Check failed - alarm will ring as backup', 'normal');
                isSnowDay = false; // Default to normal day if check fails
                console.error('Check failed:', error);
            }
        }

        function isValidSnowDay(html) {
            const text = html.toLowerCase();
            return (text.includes('north bay') && 
                   (text.includes('all buses cancelled') || 
                    text.includes('buses cancelled') || 
                    text.includes('transportation cancelled'))) ||
                   (text.includes('all zones') && text.includes('buses cancelled')) ||
                   (text.includes('system-wide') && text.includes('buses cancelled'));
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (type === 'snowday' ? 'alarm-cancelled' : 'normal');
        }

        function manualCheck() {
            checkSnowDay();
        }

        // Auto-check every 5 minutes
        setInterval(checkSnowDay, 300000);
        
        // Check immediately on load
        window.onload = function() {
            checkSnowDay();
        };
    </script>
</body>
</html>
